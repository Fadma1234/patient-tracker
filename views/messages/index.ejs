<%- include('../partials/header') %>

<h1 class="mb-4">Messages</h1>

<% if (conversations && conversations.length > 0) { %>
  <div class="list-group">
    <% conversations.forEach(conv => { %>
      <a href="/messages/<%= conv.partner._id %>" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
        <div>
          <h5 class="mb-1">
            <%= conv.partner.profile.firstName %> <%= conv.partner.profile.lastName %>
            <small class="text-muted">(<%= conv.partner.role %>)</small>
          </h5>
          <p class="mb-1 text-muted">
            <%= conv.lastMessage.content.substring(0, 50) %><%= conv.lastMessage.content.length > 50 ? '...' : '' %>
          </p>
          <small class="text-muted">
            <%= new Date(conv.lastMessage.createdAt).toLocaleDateString() %> at 
            <%= new Date(conv.lastMessage.createdAt).toLocaleTimeString() %>
          </small>
        </div>
        <% if (conv.unreadCount > 0) { %>
          <span class="badge bg-primary rounded-pill"><%= conv.unreadCount %></span>
        <% } %>
      </a>
    <% }) %>
  </div>
<% } else { %>
  <div class="alert alert-info">
    No messages yet. 
    <% if (user.role === 'patient' && user.therapistId) { %>
      <a href="/messages/<%= user.therapistId %>">Message your therapist</a>
    <% } %>
  </div>
<% } %>

<%- include('../partials/footer') %>